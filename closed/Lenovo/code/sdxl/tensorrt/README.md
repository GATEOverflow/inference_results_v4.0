# Stable Diffusion XL Benchmark

This benchmark performs object detection using the [Stable Diffusion XL](https://huggingface.co/docs/diffusers/using-diffusers/sdxl) network and a subset of COCO2014 dataset.

:warning: **IMPORTANT**: Please use [closed/NVIDIA](closed/NVIDIA) as the working directory when
running the below commands. :warning:

## Model

### Downloading / obtaining the model

The pytorch model is downloaded from the [Hugging Face snapshot](https://cloud.mlcommons.org/index.php/s/DjnCSGyNBkWA4Ro) provided by the MLCommon. The Pytorch model is subsequently processed into 4 onnx models under `$MLPERF_SCRATCH_PATH/models/SDXL/onnx_models`.

Please run `BENCHMARKS=sdxl make downdload_model` for the download and post-processing.

## Dataset

### Downloading / obtaining the dataset

The dataset used for this benchmark is [5K subset of COCO2014](https://github.com/mlcommons/inference/blob/master/text_to_image/coco2014/captions/captions_source.tsv). You can run `BENCHMARKS=sdxl make download_data` to download the data to `$MLPERF_SCRATCH_PATH/data`.

### Preprocessing the dataset for usage

To process the input captions to numpy files and download the initial noist latent generated by mlcommons, please run `BENCHMARKS=sdxl make prepreocess_data`. The preprocessed data will be saved to `$MLPERF_SCRATCH_PATH/preprocessed_data/coco2014-tokenized-sdxl/5k_dataset_final`.

### Optimizations

#### Lower Precision

To further optimize performance, with minimal impact on classification accuracy, we run the UNetXL computations in INT8-FP16 mixed precision.

### Calibration

UNetXL INT8-FP16 mixed precision is calibrated on the [official calibration dataset](https://github.com/mlcommons/inference/blob/master/calibration/COCO-2014/coco_cal_captions_list.txt) using NVIDIA AMMO v0.5.

## Instructions for Audits

### Run Inference through LoadGen

Run the following commands from within the container to run inference through LoadGen:

```
make generate_engines RUN_ARGS="--benchmarks=sdxl --scenarios=<SCENARIO>"
make run_harness RUN_ARGS="--benchmarks=sdxl --scenarios=<SCENARIO> --test_mode=PerformanceOnly"
make run_harness RUN_ARGS="--benchmarks=sdxl --scenarios=<SCENARIO> --test_mode=AccuracyOnly"
```

The performance and the accuracy results will be printed to stdout, and the LoadGen logs can be found in `build/logs`.
